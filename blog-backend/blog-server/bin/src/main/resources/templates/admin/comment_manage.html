<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org" th:with="title='评论管理',active='comment'">
<header th:replace="admin/header::headerFragment(${title},${active})"></header>
<body>

<div id="wrapper">
    <div th:replace="admin/header::header-body"></div>
    <div class="content-page">
        <div class="content">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-sm-12">
                        <h4 class="page-title">评论管理</h4>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h4 class="panel-title">评论列表</h4>
                                    </div>
                                    <div class="col-md-6 text-right">
                                        <select id="pageFilter" class="form-control" style="width: 200px; display: inline-block;" onchange="filterByPage()">
                                            <option value="">请选择页面</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="panel-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead>
                                        <tr>
                                            <th width="5%" class="text-center">评论ID</th>
                                            <th width="6%" class="text-center">头像</th>
                                            <th width="8%" class="text-center">昵称</th>
                                            <th width="12%" class="text-center">邮箱</th>
                                            <th width="10%" class="text-center">网站</th>
                                            <th width="10%" class="text-center">IP</th>
                                            <th width="15%" class="text-center">评论内容</th>
                                            <th width="6%" class="text-center">QQ</th>
                                            <th width="8%" class="text-center">所在页面</th>
                                            <th width="10%" class="text-center">发表时间</th>
                                            <th width="5%" class="text-center">是否公开</th>
                                            <th width="5%" class="text-center">邮件提醒</th>
                                            <th width="10%" class="text-center">操作</th>
                                        </tr>
                                        </thead>
                                        <tbody id="commentList">
                                        <tr>
                                            <td colspan="13" class="text-center" style="padding: 40px;">
                                                <i class="fa fa-comments" style="font-size: 48px; color: #ccc;"></i>
                                                <p style="color: #999; margin-top: 15px;">暂无评论数据</p>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div th:replace="admin/footer :: footer-content"></div>
            </div>
        </div>
    </div>
</div>

<!-- 编辑评论模态框 -->
<div class="modal fade" id="commentModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="modalTitle">编辑评论</h4>
            </div>
            <div class="modal-body">
                <form id="commentForm" onsubmit="return false;">
                    <input type="hidden" id="commentId" name="id">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="commentNickname">昵称 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="commentNickname" name="nickname" 
                                       placeholder="请输入昵称" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="commentEmail">邮箱</label>
                                <input type="email" class="form-control" id="commentEmail" name="email"
                                       placeholder="example@domain.com">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="commentWebsite">网站</label>
                                <input type="url" class="form-control" id="commentWebsite" name="website"
                                       placeholder="https://example.com">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="commentQq">QQ</label>
                                <input type="text" class="form-control" id="commentQq" name="qq"
                                       placeholder="QQ号">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="commentAvatar">头像地址</label>
                        <input type="url" class="form-control" id="commentAvatar" name="avatar"
                               placeholder="https://example.com/avatar.jpg">
                    </div>
                    
                    <div class="form-group">
                        <label for="commentContent">评论内容 <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="commentContent" name="content" rows="4"
                                  placeholder="请输入评论内容" required></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="checkbox">
                                <label>
                                    <input type="checkbox" id="commentIsPublic" name="isPublic" checked> 是否公开
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="checkbox">
                                <label>
                                    <input type="checkbox" id="commentEmailNotify" name="emailNotify"> 邮件提醒
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveComment()">
                    <i class="fa fa-save"></i> 保存
                </button>
            </div>
        </div>
    </div>
</div>

<div th:replace="admin/footer :: footer"></div>
<script>
// 页面加载时获取评论列表
$(document).ready(function() {
    loadComments();
    loadArticlesForFilter();
});

// 加载评论列表
function loadComments(pageFilter) {
    var url = '/admin/comments';
    var params = [];
    
    if (pageFilter) {
        if (pageFilter.startsWith('article_')) {
            // 文章页面
            var articleId = pageFilter.replace('article_', '');
            params.push('articleId=' + articleId);
        } else {
            // 其他页面（友链、关于等）
            params.push('page=' + pageFilter);
        }
    }
    
    if (params.length > 0) {
        url += '?' + params.join('&');
    }
    
    
    BlogAdmin.get(url, function(result) {
        if (result.data && result.data.length > 0) {
            var html = '';
            result.data.forEach(function(comment) {
                html += '<tr>';
                html += '<td class="text-center">' + comment.id + '</td>';
                // 头像 - 圆角方形
                html += '<td class="text-center">';
                if (comment.avatar) {
                    html += '<img src="' + comment.avatar + '" class="comment-avatar" onerror="this.style.display=\'none\';this.nextElementSibling.style.display=\'flex\';" />';
                    html += '<div class="comment-avatar-default" style="display: none;">' + (comment.nickname.charAt(0).toUpperCase()) + '</div>';
                } else {
                    html += '<div class="comment-avatar-default">' + (comment.nickname.charAt(0).toUpperCase()) + '</div>';
                }
                html += '</td>';
                html += '<td class="text-center">' + comment.nickname + '</td>';
                html += '<td class="text-center">' + (comment.email || '-') + '</td>';
                html += '<td class="text-center">' + (comment.website ? '<a href="' + comment.website + '" target="_blank">访问</a>' : '-') + '</td>';
                html += '<td class="text-center">' + (comment.ip || '-') + '</td>';
                html += '<td class="text-center"><div class="comment-content-preview">' + (comment.content || '-') + '</div></td>';
                html += '<td class="text-center">' + (comment.qq || '-') + '</td>';
                // 页面信息处理
                var pageInfo = '-';
                if (comment.articleTitle) {
                    pageInfo = comment.articleTitle;
                } else if (comment.page) {
                    switch(comment.page) {
                        case 'friends':
                            pageInfo = '<span class="label label-info">友链页面</span>';
                            break;
                        case 'about':
                            pageInfo = '<span class="label label-success">关于页面</span>';
                            break;
                        case 'moment':
                            pageInfo = '<span class="label label-warning">动态页面</span>';
                            break;
                        default:
                            pageInfo = comment.page;
                    }
                }
                html += '<td class="text-center">' + pageInfo + '</td>';
                html += '<td class="text-center">' + formatDateTime(comment.createTime) + '</td>';
                // 是否公开开关
                var isPublicChecked = comment.status === 1 ? 'checked' : '';
                html += '<td class="text-center"><label class="switch"><input type="checkbox" ' + isPublicChecked + ' onchange="togglePublic(' + comment.id + ', this.checked)"><span class="slider"></span></label></td>';
                // 邮件提醒开关
                var emailNotifyChecked = comment.emailNotify === 1 ? 'checked' : '';
                html += '<td class="text-center"><label class="switch"><input type="checkbox" ' + emailNotifyChecked + ' onchange="toggleEmailNotify(' + comment.id + ', this.checked)"><span class="slider"></span></label></td>';
                html += '<td class="text-center">';
                html += '<button class="btn btn-sm btn-info" onclick="editComment(' + comment.id + ')" title="编辑"><i class="fa fa-edit"></i> 编辑</button> ';
                html += '<button class="btn btn-sm btn-danger" onclick="deleteComment(' + comment.id + ')" title="删除"><i class="fa fa-trash"></i> 删除</button>';
                html += '</td>';
                html += '</tr>';
            });
            $('#commentList').html(html);
        } else {
            $('#commentList').html('<tr><td colspan="13" class="text-center" style="padding: 40px;"><i class="fa fa-comments" style="font-size: 48px; color: #ccc;"></i><p style="color: #999; margin-top: 15px;">暂无评论数据</p></td></tr>');
        }
    }, function() {
        console.log('加载评论列表失败');
    });
}

// 加载文章列表用于筛选
function loadArticlesForFilter() {
    // 添加固定的页面选项
    var html = '<option value="">请选择页面</option>';
    html += '<option value="friends">友链页面</option>';
    html += '<option value="about">关于页面</option>';
    html += '<option value="moment">动态页面</option>';
    html += '<optgroup label="文章页面">';
    
    BlogAdmin.get('/admin/articles', function(result) {
        if (result.data && result.data.length > 0) {
            result.data.forEach(function(article) {
                html += '<option value="article_' + article.id + '">' + article.title + '</option>';
            });
        }
        html += '</optgroup>';
        $('#pageFilter').html(html);
    }, function() {
        // 即使文章加载失败，也要显示固定页面选项
        html += '</optgroup>';
        $('#pageFilter').html(html);
    });
}

// 按页面筛选
function filterByPage() {
    var pageFilter = $('#pageFilter').val();
    loadComments(pageFilter);
}

// 编辑评论
function editComment(id) {
    BlogAdmin.get('/admin/comments/' + id, function(result) {
        if (result.data) {
            var comment = result.data;
            $('#commentId').val(comment.id);
            $('#commentNickname').val(comment.nickname);
            $('#commentEmail').val(comment.email || '');
            $('#commentWebsite').val(comment.website || '');
            $('#commentQq').val(comment.qq || '');
            $('#commentAvatar').val(comment.logo || '');
            $('#commentContent').val(comment.content);
            $('#commentIsPublic').prop('checked', comment.status === 1);
            $('#commentEmailNotify').prop('checked', comment.emailNotify === 1);
            $('#modalTitle').text('编辑评论');
            $('#commentModal').modal('show');
        }
    });
}

// 保存评论
function saveComment() {
    var id = $('#commentId').val();
    var nickname = $('#commentNickname').val().trim();
    var email = $('#commentEmail').val().trim();
    var website = $('#commentWebsite').val().trim();
    var qq = $('#commentQq').val().trim();
    var logo = $('#commentAvatar').val().trim();
    var content = $('#commentContent').val().trim();
    var status = $('#commentIsPublic').is(':checked') ? 1 : 0;
    var emailNotify = $('#commentEmailNotify').is(':checked') ? 1 : 0;
    
    if (!nickname) {
        alert('请输入昵称');
        return;
    }
    
    if (!content) {
        alert('请输入评论内容');
        return;
    }
    
    var data = {
        nickname: nickname,
        email: email,
        website: website,
        qq: qq,
        logo: logo,
        content: content,
        status: status,
        emailNotify: emailNotify
    };
    
    BlogAdmin.put('/admin/comments/' + id, data, function(result) {
        BlogAdmin.success('评论更新成功');
        $('#commentModal').modal('hide');
        loadComments();
    });
}

// 切换公开状态
function togglePublic(id, isPublic) {
    BlogAdmin.get('/admin/comments/' + id, function(result) {
        if (result.data) {
            var comment = result.data;
            comment.status = isPublic ? 1 : 0;
            BlogAdmin.put('/admin/comments/' + id, comment, function() {
                BlogAdmin.success('公开状态已更新');
            });
        }
    });
}

// 切换邮件提醒
function toggleEmailNotify(id, emailNotify) {
    BlogAdmin.get('/admin/comments/' + id, function(result) {
        if (result.data) {
            var comment = result.data;
            comment.emailNotify = emailNotify ? 1 : 0;
            BlogAdmin.put('/admin/comments/' + id, comment, function() {
                BlogAdmin.success('邮件提醒状态已更新');
            });
        }
    });
}

// 删除评论
function deleteComment(id) {
    if (confirm('确定要删除这条评论吗？')) {
        BlogAdmin.delete('/admin/comments/' + id, function(result) {
            BlogAdmin.success('评论删除成功');
            loadComments();
        });
    }
}

// 格式化日期时间
function formatDateTime(dateTimeStr) {
    if (!dateTimeStr) return '-';
    var date = new Date(dateTimeStr);
    var year = date.getFullYear();
    var month = ('0' + (date.getMonth() + 1)).slice(-2);
    var day = ('0' + date.getDate()).slice(-2);
    var hours = ('0' + date.getHours()).slice(-2);
    var minutes = ('0' + date.getMinutes()).slice(-2);
    var seconds = ('0' + date.getSeconds()).slice(-2);
    return year + '-' + month + '-' + day + ' ' + hours + ':' + minutes + ':' + seconds;
}
</script>

<style>
/* 头像样式 - 圆角方形 */
.comment-avatar {
    width: 40px;
    height: 40px;
    border-radius: 6px;
    object-fit: cover;
    display: inline-block;
}

.comment-avatar-default {
    width: 40px;
    height: 40px;
    border-radius: 6px;
    background: #5fbeaa;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 16px;
}

/* 评论内容预览 */
.comment-content-preview {
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* 开关样式 */
.switch {
    position: relative;
    display: inline-block;
    width: 44px;
    height: 22px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 22px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: #5fbeaa;
}

input:checked + .slider:before {
    transform: translateX(22px);
}
</style>
</body>
</html>

